<?php
class TestSendAction extends GuestCommonAction {
	public function getNews() {
		
		
		
		
		$html_content = '<p style="clear: both; white-space: normal; padding: 0px; border: currentcolor; border-image-source: none; line-height: 24px;">
    <strong><span style="font-family: 宋体; font-size: 19px;">恭喜您成功获得</span></strong><strong><span style="font-family: Helvetica, sans-serif; font-size: 19px;">G5G6</span></strong><strong><span style="font-family: 宋体; font-size: 19px;">会员专享年终礼券&nbsp;</span></strong><strong><span style="font-family: Helvetica, sans-serif; font-size: 19px;">50</span></strong><strong><span style="font-family: 宋体; font-size: 19px;">元，请在“会员中心——我的优惠券”查看详情。</span></strong>
</p>
<p style="clear: both; white-space: normal; padding: 0px; border: currentcolor; border-image-source: none; line-height: 24px;">
    <strong><span style="color: red; font-family: 宋体; font-size: 20px;">提示语：<br/>本券使用之前请勿取消关注且请勿删除！</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="color: red; font-family: 宋体;">使用细则：</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="color: red; font-family: 宋体;">新VIP年终礼券使用细则：</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="background-color: yellow; color: rgb(62, 62, 62); font-family: Helvetica, sans-serif;">1.</span></strong><strong><span style="background-color: yellow; color: rgb(62, 62, 62); font-family: 宋体;">使用前若因删除或取消关注而造成券号密码遗失者，则视为自动放弃本券的使用权利；</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="background-color: yellow; color: rgb(62, 62, 62); font-family: Helvetica, sans-serif;">2.</span></strong><strong><span style="background-color: yellow; color: rgb(62, 62, 62); font-family: 宋体;">若因手机故障等原因造成券号密码丢失者，请恕本平台概不负责；</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="color: rgb(62, 62, 62); font-family: Helvetica, sans-serif;">3.&nbsp;</span></strong><strong><span style="color: rgb(62, 62, 62); font-family: 宋体;">G5G6VIP</span></strong><strong><span style="color: rgb(62, 62, 62); font-family: 宋体;">年终礼券必须在有效期内使用有效，过期作废；</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="color: rgb(62, 62, 62); font-family: Helvetica, sans-serif;">4.&nbsp;</span></strong><strong><span style="color: rgb(62, 62, 62); font-family: 宋体;">本券仅限新VIP开卡本人在开卡门店使用；</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="color: rgb(62, 62, 62); font-family: Helvetica, sans-serif;">5.&nbsp;</span></strong><strong><span style="color: rgb(62, 62, 62); font-family: 宋体;">本券仅限在店铺购买正价商品时使用（皮带、袜子、鞋子除外）；</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="color: rgb(62, 62, 62); font-family: Helvetica, sans-serif;">6.&nbsp;</span></strong><strong><span style="color: rgb(62, 62, 62); font-family: 宋体;">为了您自己的权益，请妥善保管自己的券号和使用密码，勿泄露给他人；</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="color: rgb(62, 62, 62); font-family: 宋体;">7.登入会员中心后，<span style="color: rgb(255, 0, 0); background-color: rgb(255, 255, 0);">点击“我的优惠券”</span>即可查看券号和密码。</span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="color: rgb(62, 62, 62); font-family: 宋体;"><img src="https://mmbiz.qlogo.cn/mmbiz/YgIa0F4V3O6yicDK0R3JsIs55rmaU3lV9ibbSaVH11WarhELP5WM0PQslQgUibK2zvP3V4980t3QUHaPSL4iatBdpA/0" data-s="300,640" data-w="424" data-ratio="1.7146226415094339" style="max-width: 100%; height: auto !important;"/></span></strong>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <br/>
</p>
<p style="clear: both; white-space: normal; line-height: 24px;">
    <strong><span style="background-color: yellow; color: red; font-family: 宋体;">温馨提示：您在店铺使用此代金券时请及时将本内容出示给店铺导购查看，以方便您的使用。感谢您的配合。</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong><span style="color: rgb(62, 62, 62); font-family: 宋体; font-size: 14px;">如有任何疑议，请联系我们的微信平台或者致电<span style="color: rgb(255, 0, 0);">0571-85399617</span>，G5G6为您竭诚服务！</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <br/><img src="https://mmbiz.qlogo.cn/mmbiz/YgIa0F4V3O6yicDK0R3JsIs55rmaU3lV9uuXQBjzpye4BmkbfgwhKHUosd31iclPXUBDgYYBJ45h9ROqG61A20PQ/0" data-w="125" data-ratio="0.56" style="max-width: 100%; height: auto !important;"/><span style="color: rgb(255, 0, 0); font-size: 12px; background-color: rgb(146, 208, 80);">前往会员中心请点击【<strong>阅读原文</strong>】</span>
</p>
<p>
    <span style="color: rgb(255, 0, 0); font-size: 12px; background-color: rgb(146, 208, 80);"><br/></span>
</p>
<p>
    <br/>
</p>';
		
		
		
		$digest = '1.年终券券号和密码请一律前往“会员中心”进行查询；
2.前往“会员中心”请点击正文中左下角的“阅读原文”进行登录；
3.若有疑问，请拨打热线： 0571-85399617。';
		
		
		
		
		
		
		$swc = A ( 'Service/WeChat' );
		$imagepath = '/Updata/images/201405291912250003/plugin/coupon/coupon00001/newyearfinal.jpg';
		
		$cover_media = $swc->uploadImage ( $this->einfo, $imagepath ); // 调用接口获得图片media_id
		
		$articleinfo = array (
				"articles" => array (
						0 => array (
								"thumb_media_id" => $cover_media,
								"author" => "G5G6",
								"title" => "恭喜您成功获取年终礼券 50元，请点击查看详情。",
								"content_source_url" => "http://www.we-act.cn/weact/Home/MemberHandle/customerCoupon/e_id/201405291912250003",
								"content" => $html_content,
								"digest" => $digest,
								"show_cover_pic" => "1" 
						) 
				) 
		);
		
		$newsinfo = $swc->uploadNewsMsg ( $this->einfo, $articleinfo ); // 调用接口上传图文信息并获得返回
		
		$groupsendinfo = array (
				"filter" => array (
						"is_to_all" => false,
						"group_id" => 102
				),
				"mpnews" => array (
						"media_id" => $newsinfo ['media_id'] 
				),
				"msgtype" => "mpnews" 
		);
		$sendresult = $swc->groupSendNews( $this->einfo, $groupsendinfo );
		p( $sendresult );die;
	}
	
	public function getBirthday() {
		
		$html_content = '<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 19px; word-wrap: break-word !important; box-sizing: border-box !important;">恭喜您成功获得</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: Helvetica, sans-serif; font-size: 19px; word-wrap: break-word !important; box-sizing: border-box !important;">G5G6</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 19px; word-wrap: break-word !important; box-sizing: border-box !important;">会员专享生日礼券</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: Helvetica, sans-serif; font-size: 19px; word-wrap: break-word !important; box-sizing: border-box !important;">50</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 19px; word-wrap: break-word !important; box-sizing: border-box !important;">元，请在“会员中心——我的优惠券”查看详情。</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; color: red; font-family: 宋体; font-size: 20px; word-wrap: break-word !important; box-sizing: border-box !important;">提示语：<br style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"/>本券使用之前请勿取消关注且请勿删除！</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; color: red; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">使用细则：</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; color: red; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">新VIP生日礼券使用细则：</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; background-color: yellow; font-family: Helvetica, sans-serif; word-wrap: break-word !important; box-sizing: border-box !important;">1.</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; background-color: yellow; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">使用前若因删除或取消关注而造成券号密码遗失者，则视为自动放弃本券的使用权利；</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; background-color: yellow; font-family: Helvetica, sans-serif; word-wrap: break-word !important; box-sizing: border-box !important;">2.</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; background-color: yellow; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">若因手机故障等原因造成券号密码丢失者，请恕本平台概不负责；</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: Helvetica, sans-serif; word-wrap: break-word !important; box-sizing: border-box !important;">3.&nbsp;</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">G5G6VIP</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">生日礼券必须在有效期内使用有效，过期作废；</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: Helvetica, sans-serif; word-wrap: break-word !important; box-sizing: border-box !important;">4.&nbsp;</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">本券仅限新VIP开卡本人在开卡门店使用；</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: Helvetica, sans-serif; word-wrap: break-word !important; box-sizing: border-box !important;">5.&nbsp;</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">本券仅限在店铺购买正价商品时使用（皮带、袜子、鞋子除外）；</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: Helvetica, sans-serif; word-wrap: break-word !important; box-sizing: border-box !important;">6.&nbsp;</span></strong><strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">为了您自己的权益，请妥善保管自己的券号和使用密码，勿泄露给他人；</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">7.登入会员中心后，<span style="max-width: 100%; color: rgb(255, 0, 0); background-color: rgb(255, 255, 0); word-wrap: break-word !important; box-sizing: border-box !important;">点击“我的优惠券”</span>即可查看券号和密码。</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;"><img src="https://mmbiz.qlogo.cn/mmbiz/YgIa0F4V3O6yicDK0R3JsIs55rmaU3lV9ibbSaVH11WarhELP5WM0PQslQgUibK2zvP3V4980t3QUHaPSL4iatBdpA/0" data-s="300,640" data-w="424" data-ratio="1.7146226415094339" data-src="https://mmbiz.qlogo.cn/mmbiz/YgIa0F4V3O6yicDK0R3JsIs55rmaU3lV9ibbSaVH11WarhELP5WM0PQslQgUibK2zvP3V4980t3QUHaPSL4iatBdpA/640?tp=webp" style="max-width: 100%; height: auto !important; word-wrap: break-word !important; box-sizing: border-box !important; width: auto !important; visibility: visible !important;"/></span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <br style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"/>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; background-color: yellow; color: red; font-family: 宋体; word-wrap: break-word !important; box-sizing: border-box !important;">温馨提示：您在店铺使用此代金券时请及时将本内容出示给店铺导购查看，以方便您的使用。感谢您的配合。</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; word-wrap: break-word !important; box-sizing: border-box !important;">如有任何疑议，请联系我们的微信平台或者致电<span style="max-width: 100%; color: rgb(255, 0, 0); word-wrap: break-word !important; box-sizing: border-box !important;">0571-85399617</span>，G5G6为您竭诚服务！</span></strong>
</p>
<p style="clear: both; white-space: normal;">
    <br style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"/><img src="https://mmbiz.qlogo.cn/mmbiz/YgIa0F4V3O6yicDK0R3JsIs55rmaU3lV9uuXQBjzpye4BmkbfgwhKHUosd31iclPXUBDgYYBJ45h9ROqG61A20PQ/0" data-w="125" data-ratio="0.56" data-src="https://mmbiz.qlogo.cn/mmbiz/YgIa0F4V3O6yicDK0R3JsIs55rmaU3lV9uuXQBjzpye4BmkbfgwhKHUosd31iclPXUBDgYYBJ45h9ROqG61A20PQ/0?tp=webp" style="max-width: 100%; height: auto !important; word-wrap: break-word !important; box-sizing: border-box !important; width: auto !important; visibility: visible !important;"/><span style="max-width: 100%; color: rgb(255, 0, 0); font-size: 12px; background-color: rgb(146, 208, 80); word-wrap: break-word !important; box-sizing: border-box !important;">前往会员中心请点击【<strong style="max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;">阅读原文</strong>】</span>
</p>
<p>
    <span style="max-width: 100%; color: rgb(255, 0, 0); font-size: 12px; background-color: rgb(146, 208, 80); word-wrap: break-word !important; box-sizing: border-box !important;"><br/></span>
</p>
<p>
    <br/>
</p>';
		
		$digest = '恭喜您成功获得G5G6会员专享生日礼券 50元，请在“会员中心——我的优惠券”查看详情。提示语：本券使用之前请勿删除。';
		
		
		$swc = A ( 'Service/WeChat' );
		$imagepath = '/Updata/images/201405291912250003/plugin/coupon/coupon00002/birthdaycoupon.jpg';
		
		$cover_media = $swc->uploadImage ( $this->einfo, $imagepath ); // 调用接口获得图片media_id
		
		$articleinfo = array (
				"articles" => array (
						0 => array (
								"thumb_media_id" => $cover_media,
								"author" => "G5G6",
								"title" => "恭喜您成功获取生日礼券 50元，请点击查看详情。",
								"content_source_url" => "http://www.we-act.cn/weact/Home/MemberHandle/customerCoupon/e_id/201405291912250003",
								"content" => $html_content,
								"digest" => $digest,
								"show_cover_pic" => "1"
						)
				)
		);
		
		$newsinfo = $swc->uploadNewsMsg ( $this->einfo, $articleinfo ); // 调用接口上传图文信息并获得返回
		
		$groupsendinfo = array (
				"filter" => array (
						"is_to_all" => false,
						"group_id" => 103
				),
				"mpnews" => array (
						"media_id" => $newsinfo ['media_id']
				),
				"msgtype" => "mpnews"
		);
		$sendresult = $swc->groupSendNews( $this->einfo, $groupsendinfo );
		p( $sendresult );die;
	}
	
	/**
	 * 发送某张优惠券给单个用户。
	 * @param string $coupon_id 要发送的优惠券编号
	 * @param string $customer_id 要接收的顾客编号
	 * @return boolean $sendstatus 发送的优惠券的状况
	 */
	public function sendCouponToCustomer($coupon_id = '', $oloffcusinfo = NULL) {
		$cp = A ( 'Service/Coupon' );
		$couponinfo = $cp->getCouponInfo( $coupon_id );										// Step1：获取优惠券信息
		$addcouponresult = $cp->addCustomerCoupon( $couponinfo, $oloffcusinfo ); 			// Step2：发放优惠券信息
		//if($addcouponresult) $cp->sendCouponRemind( $this->einfo, $customerinfo, 'msg0000000000000015'); // Step3：发放成功图文提醒
	}
	
	public function batchSendCouponTip($coupon_id = '') {
		$cp = A ( 'Service/Coupon' );
		$cus = A ( 'Service/Customer' );
		$couponinfo = $cp->getCouponInfo( $coupon_id );										// Step1：获取优惠券信息
		
		$model = new Model();
		$sql = 'ci.account = oc.contact_number and ci.customer_id = cc.customer_id and cc.e_id = \'201405291912250003\' and ci.openid!=\'\'';
		$field = 'ci.customer_id, ci.openid, ci.account, oc.original_id, oc.member_card, oc.customer_name, oc.sex, oc.id_card, oc.birthday, oc.card_start, oc.card_end, oc.subbranch_id, oc.subbranch_original_id, cc.coupon_name, cc.get_time, cc.coupon_sncode, cc.coupon_password';
		$customercouponinfo = $model->table('t_customerinfo ci, t_offlinecustomer oc, t_customercoupon cc')->where($sql)->field($field)->select();
		
		for($i = 0; $i < count($customercouponinfo); $i ++){
			$cp->sendCouponRemind( $this->einfo, $customerinfo, 'msg0000000000000015');
		}
		p('发送信息成功!');die;
	}
	
	public function batchSendCoupon($coupon_id) {
		//$sql = 'ci.account = oc.contact_number and oc.add_time > 1420461749 and oc.e_id = \'' . $this->einfo ['e_id'] . '\' and ci.e_id = \'' . $this->einfo ['e_id'] . '\''; // 送年终券
		$sql = 'ci.account = oc.contact_number and oc.add_time > 1420481200 and oc.e_id = \'' . $this->einfo ['e_id'] . '\' and ci.e_id = \'' . $this->einfo ['e_id'] . '\''; // 送生日券
		$model = new Model();
		$allmember = $model->table('t_customerinfo ci, t_offlinecustomer oc')->where($sql)->field('*')->group('ci.account')->select();
		//p($allmember);die;
		for($i = 0; $i < count( $allmember ); $i ++){
			$this->sendCouponToCustomer( $coupon_id, $allmember [$i] );
		}
	}
	
	public function setCoupon() {
		// 加载第三方类库PHPExcel
		vendor ( 'PHPExcel.PHPExcel' );
		vendor ( 'PHPExcel.PHPExcel.IOFactory' );
		vendor ( 'PHPExcel.PHPExcel.Reader.Excel5' );
		vendor ( 'PHPExcel.PHPExcel.Reader.Excel2007' );
		
		// 加载excel文件
		//$inputfilename = $uploadresult [0] ['savepath'] . $uploadresult [0] ['savename'];
		//$extension = $uploadresult [0] ['extension'];
		$inputfilename = 'D:\srq1089.xls';
		$extension = 'xls';
		
		switch ($extension) {
			case 'xls' :
				$objReader = new PHPExcel_Reader_Excel5 ();
				break;
			case 'xlsx' :
				$objReader = new PHPExcel_Reader_Excel2007 ();
				break;
			case 'csv' :
				$objReader = new PHPExcel_Reader_CSV ();
				break;
			default :
				$this->error ( '上传的文件类型不匹配，无法识别！' );
				break;
		}
		
		$objPHPExcel = $objReader->load ( $inputfilename );		// 读取Excel
		$currentsheet = $objPHPExcel->getActiveSheet (); 		// 获取活动工作薄
		$allcolumn = $currentsheet->getHighestColumn ();		// 获取最大列数
		$allrow = $currentsheet->getHighestRow ();				// 获取最大行数
		$allcolumnindex = PHPExcel_Cell::columnIndexFromString ( $allcolumn ); // 将列数的字母索引转换成数字（重要）
		
		// 开始读取数据
		$global = array();
		// 读取excel文件中的数据
		for($row = 2; $row <= $allrow; $row ++) {
			$singlerecord = array ();
			for($column = 0; $column < 2; $column ++) {
				$singlerecord [$column] = $currentsheet->getCellByColumnAndRow ( $column, $row )->getValue ();
			}
			$global [$row - 2] = $singlerecord;
		}
		//p($global);die;
		
		$cctable = M ( 'customercoupon' );
		$ccmap = array(
				'get_time' => array('gt', 1420481200),
				'is_del' => 0
		);
		$allneedset = $cctable->where( $ccmap )->order( 'get_time asc' )->select();
		//p($allneedset);die;
		for($i = 0; $i < count ($global); $i ++) {
			$allneedset [$i] ['coupon_sncode'] = $global [$i] [0];
			$allneedset [$i] ['coupon_password'] = $global [$i] [1];
			$result = $cctable->save( $allneedset [$i] );
		}
		p('set completed.');die;
	}
	
	/**
	 * 特别注意：这种批量移动到某分组，在后台一次最多只允许移动10个人！
	 */
	public function batchMoveUser(){
		//$cp = A ( 'Service/Coupon' );
		//$cus = A ( 'Service/Customer' );
		//$couponinfo = $cp->getCouponInfo( $coupon_id );										// Step1：获取优惠券信息
		
		$model = new Model();
		$sql = 'ci.account = oc.contact_number and ci.customer_id = cc.customer_id and oc.add_time > 1420481200 and cc.coupon_id = \'whkhpujwfhkus320980rwghq\' and cc.get_time > 1420481200 and cc.e_id = \'201405291912250003\' and ci.openid!=\'\'';
		$field = 'ci.customer_id, ci.openid, ci.account, oc.original_id, oc.member_card, oc.customer_name, oc.sex, oc.id_card, oc.birthday, oc.card_start, oc.card_end, oc.subbranch_id, oc.subbranch_original_id, cc.coupon_name, cc.get_time, cc.coupon_sncode, cc.coupon_password';
		$customercouponinfo = $model->table('t_customerinfo ci, t_offlinecustomer oc, t_customercoupon cc')->where($sql)->field($field)->select();
		//$totalnumber = count($customercouponinfo);
		//p($totalnumber);die;
		//p($customercouponinfo);die;
		$swc = A ( 'Service/WeChat' );
		$openidlist = array(); // 用户微信数组
		for($i = 0; $i < count ( $customercouponinfo ); $i ++) {
			$openidlist [$i] = $customercouponinfo [$i] ['openid'];
			//$openid = $customercouponinfo [$i] ['openid'];
			//$group_id = 102; // 群发年终券
			$group_id = 103; // 群发生日券
			//$result = $swc->moveUserToGroup($this->einfo, $openid, $group_id);
		}
		$swc->batchMoveUserToGroup( $this->einfo, $openidlist, $group_id );
		p('move ok');die;
	}
	
	public function WeChatUser() {
		$start = time();
		$swc = A('Service/WeChat');
		$allsubscriber = $swc->allSubscriber ($this->einfo);
		
		// 同步组内用户信息
		/**
		 * Step1：将微信平台返回的数据按格式打包
		 * （此处忽略用户分组查询，鉴于可能会影响同步用户的时间复杂度，考虑把它放到同步组或用户信息中去同步），
		 * 测试报告：（勿删）
		 * 考虑到内存比对的开销较大，本来想过滤掉del再查询，却发现数据量大了后，空间复杂度开销比时间复杂度更大，
		 * 而且取消关注的人不会在千、万级，加之用户组信息比较宝贵，所以还是保留这个开销。
		 * $swc->batchQueryUserGroup这个方法虽然是批量查询时间复杂度更小，但是整体查询上万用户时间量也很大。
		 * 所以最终决定在同步所有用户信息的时候，为了体验度，不保留组信息比对。
		 */
		
		$remoteuser = $allsubscriber ['data'] ['openid'];
		
		// Step2：查询本地数据并按格式打包
		$localusermap = array (
				'enterprise_wechat' => $this->einfo ['original_id'],
				'is_del' => 0
		);
		$localuser = M ( 'wechatuserinfo' )->where ( $localusermap )->select ();
		
		$checkuser = hashUserPick( $remoteuser, $localuser, 'openid' );
		
		//p($checkuser);die;
		
		// 处理删除的用户信息（delete）
		for($i = 0; $i < count ( $checkuser ['del'] ); $i ++) {
			$deletedate = array (
					'enterprise_wechat' => $this->einfo ['original_id'],
					'openid' => $checkuser ['del'] [$i], // $checkuser ['del'] [$i]直接是openid
					'is_del' => 0
			);
			$deleteresult = M ( 'wechatuserinfo' )->where ( $deletedate )->setField('is_del', 1);
		}
		
		$Maxadd = C ( 'MAX_ADD_COUNT' ); // 获取一次限定操作的次数
		
		// 处理增加的用户信息（add）
		$addrecyclecount = intval(count ( $checkuser ['add'] ) / $Maxadd); // 计算增加操作的循环次数（特别注意，必须转整！不然直接报错）
		$leftaddcount = intval(count ( $checkuser ['add'] ) % $Maxadd); // 计算增加操作的余数
		$totalhandleuser = 0; // 本次总批量处理用户数
		
		// 根据addAll每次的最大次数来循环插入（暂时先不更新用户组信息和关注时间）
		for($i = 0; $i < $addrecyclecount; $i ++) {
			for($j = 0; $j < $Maxadd; $j ++) {
				$adddate [$j] = array (
						'user_info_id' => md5 ( uniqid ( rand (), true ) ),
						'enterprise_wechat' => $this->einfo ['original_id'],
						'group_id' => 0, // 默认新插入用户都在未分组，以后同步信息的时候再更新其组信息
						'subscribe' => 1,
						'openid' => $checkuser ['add'] [$i * $Maxadd + $j],
						'add_time' => time()
				);
			}
			$totalhandleuser += M ( 'wechatuserinfo' )->addAll ( $adddate );
		}
		// 插入余下的数据
		for($k = 0; $k < $leftaddcount; $k ++) {
			$addleftdate [$k] = array (
					'user_info_id' => md5 ( uniqid ( rand (), true ) ),
					'enterprise_wechat' => $this->einfo ['original_id'],
					//'group_id' => $checkuser ['add'] [$addrecyclecount * $Maxadd + $k] ['group_id'],
					'group_id' => 0, //暂时不更新组信息
					'subscribe' => 1,
					'openid' => $checkuser ['add'] [$addrecyclecount * $Maxadd + $k],
					'add_time' => time()
			);
		}
		$totalhandleuser += M ( 'wechatuserinfo' )->addAll ( $addleftdate );
		$end = time();
		$timespan = $end-$start;
		$number = count($allsubscriber ['data'] ['openid']);
		p('同步'.$number.'个用户完成，花了：'.$timespan.'秒!');die;
	}
	
	/**
	 * 为本地微信用户更新信息。
	 * 不更新0秒，5个用户全部更新用了2秒，10个用户全部更新用了1秒，
	 * 20个用户全部更新用了3秒，50个用户全部更新用了8秒，100个用户全部更新用了14秒，137个用户（37个更新）用了16秒，
	 * 1000个用户全部更新用了144秒，1000个用户都不更新用了112秒，
	 * 10000个用户
	 */
	public function subscriberInfo() {
		$start = time();
		$swc = A ('Service/WeChat');
		
		$usermap = array(
				'enterprise_wechat' => $this->einfo ['original_id'],
				'is_del' => 0
		);
		$localuser = M('wechatuserinfo')->where($usermap)->limit(1000)->select();
		
		$syncnum = count($localuser); // 总计循环变量
		
		$requestlist = array(); // 要请求的用户openid列表
		for($i = 0; $i < $syncnum; $i ++) {
			$requestlist [$i] = $localuser [$i] ['openid'];
		}
		$remoteuser = $swc->batchWeChatUserInfo( $this->einfo, $requestlist ); // 批量请求的数据顺序跟本地同
		
		$remoteformat = array(); // 远程数据格式化成本地格式
		for($i = 0; $i < $syncnum; $i ++) {
			$remoteformat [$i] = array(
					'user_info_id' => $localuser [$i] ['user_info_id'],
					'enterprise_wechat' => $localuser [$i] ['enterprise_wechat'],
					'group_id' => $localuser [$i] ['group_id'],
					'subscribe' => $remoteuser [$i] ['subscribe'], // 更新的字段1
					'openid' => $remoteuser [$i] ['openid'],
					'nickname' => $remoteuser [$i] ['nickname'], // 更新的字段2
					'sex' => $remoteuser [$i] ['sex'], // 更新的字段3
					'language' => $remoteuser [$i] ['language'], // 更新的字段4
					'city' => $remoteuser [$i] ['city'], // 更新的字段5
					'province' => $remoteuser [$i] ['province'], // 更新的字段6
					'country' => $remoteuser [$i] ['country'], // 更新的字段7
					'head_img_url' => $remoteuser [$i] ['headimgurl'], // 更新的字段8
					'subscribe_time' => $remoteuser [$i] ['subscribe_time'], // 更新的字段9
					'add_time' => $localuser [$i] ['add_time'],
					'remark' => $remoteuser [$i] ['remark'], // 更新的字段10
					'is_del' => $localuser [$i] ['is_del'],
			);
		}
		
		$pickresult = autoPick ( $remoteformat, $localuser, 'openid' ); // 自动分拣
		
		$updatenum = 0; // 总计更新的用户数量
		$infotable = M ('wechatuserinfo');
		for($i = 0; $i < count( $pickresult ['update'] ); $i ++) {
			$updatenum += $infotable->save( $pickresult ['update'] [$i] );
		}
		
		$end = time();
		$timespan = $end - $start;
		p('请求并同步'.$syncnum.'个用户的信息完成，对该企业下'.$updatenum.'个用户信息进行更新，总计花了：'.$timespan.'秒!\n');p($remoteuser);die;
	}
	
	public function subscriberInfo2() {
		$start = time();
		$swc = A('Service/WeChat');
		$usermap = array(
				'enterprise_wechat' => $this->einfo ['original_id'],
				'is_del' => 0
		);
		$wechaterlist = M('wechatuserinfo')->where($usermap)->select();
	
		$result = array();
		for($i = 0; $i < count($wechaterlist); $i ++) {
			$result [$i] = $swc->getUserInfo( $this->einfo, $wechaterlist [$i] ['openid'] );
		}
		
		$end = time();
		$number = count($result);
		$timespan = $end - $start;
		p('请求'.$number.'个用户的信息完成，花了：'.$timespan.'秒!\n');p($result);die;
	}
	
	public function delegate() {
		$emap = array(
				'enterprise_wechat' => $this->einfo ['original_id'],
				'is_del' => 0
		);
		
		$wechatuserlist = M('wechatuserinfo')->where($emap)->select();
		
		for($i = 0; $i < count($wechatuserlist); $i ++){
			$wechatuserlist [$i] ['subscribe_time'] = timetodate($wechatuserlist [$i] ['subscribe_time']);
		}
		//p($wechatuserlist);die;
		
		$citable = M('customerinfo');
		for($i = 0; $i < count($wechatuserlist); $i ++){
			
			$cimap = array(
					'e_id' => $this->einfo ['e_id'],
					'openid' => $wechatuserlist [$i] ['openid'],
					'is_del' => 0
			);
			$singleexist = $citable->where($cimap)->find();
			if(! $singleexist){
				$date = $wechatuserlist [$i] ['subscribe_time'];
				$year = date("Y", strtotime($date));
				$month = date("m", strtotime($date));
				$day = date("d", strtotime($date));
				$hour = date("H", strtotime($date));
				$minute = date("i", strtotime($date));
				$second = date("s", strtotime($date));
				$customer_id = $year.$month.$day.$hour.$minute.$minute.randCode(4, 1);
				$sex = ( $wechatuserlist [$i] ['sex'] == 1 ) ? '男' : '女';
				$newinfo = array(
						'customer_id' => $customer_id,
						'openid' => $wechatuserlist [$i] ['openid'],
						'nick_name' => $wechatuserlist [$i] ['nickname'],
						'e_id' => $this->einfo ['e_id'],
						'sex' => $sex,
						'register_time' => strtotime($date)
				);
				$result = $citable->add($newinfo);
			}
		}
		
	}
	
	/**
	 * 批量请求用户所在分组信息。
	 * 10个用户用了2秒，20个用户用了2秒，50个用户用了5秒，75个用户用了7秒，
	 * 100个用户用了10~11秒，
	 * 500个用户用了51秒，1000个用户用了103秒，
	 * 查询接口相对比较稳定。
	 */
	public function queryGroup() {
		$swc = A('Service/WeChat');
		
		$start = time();
		
		$usermap = array(
				'enterprise_wechat' => $this->einfo ['original_id'],
				'is_del' => 0
		);
		$localuser = M('wechatuserinfo')->where($usermap)->limit(500)->select();
		//p($localuser);die;
		$num = count($localuser);
		
		$openidlist = array();
		for($i = 0; $i < $num; $i ++){
			$openidlist [$i] = $localuser [$i] ['openid'];
		}
		
		$result = $swc->batchQueryUserGroup( $this->einfo, $openidlist );
		
		$syncnumber = $this->syncBatchUserInGroup( $localuser, $result );
		
		$end = time();
		$timespan = $end - $start;
		p('请求并同步'.$num.'个用户的所在分组信息完成，对'.$syncnumber.'个用户的分组信息进行更新，总计花了：'.$timespan.'秒!\n');p($result);die;
	}
	
	/**
	 * 批量更新用户分组信息（对wechatuserinfo表的group_id进行操作）。
	 * @param array $localuser 本地微信用户数据，从wechatuserinfo表里查询出来
	 * @param array $querygroupinfo 微信平台返回的用户组信息，二维数组，只有一个groupid信息，数组大小和本地是一样的，且同序。
	 * @return number $syncOperated 更新分组信息的记录数，没有更新返回0
	 */
	public function syncBatchUserInGroup($localuser = NULL, $querygroupinfo = NULL) {
		//Step3：进行自动比对
		//Step4：对检验出更改分组的用户（应该是少量）进行组信息更新
		
		$syncOperated = 0; // 同步信息更新失败
		
		$localformat = array(); // 本地格式化数组
		$remoteformat = array(); // 远程格式化数组
		
		$total = count( $localuser ); // 总计要比对的用户数量
		
		//Step1：将本地用户和远程数据打包成比对需要字段格式
		for($i = 0; $i < $total; $i ++) {
			if(! isset ( $querygroupinfo [$i] ['errmsg'] )) {
				$localformat [$i] = array(
						'openid' => $localuser [$i] ['openid'],
						'group_id' => $localuser [$i] ['group_id']
				);
				$remoteformat [$i] = array(
						'openid' => $localuser [$i] ['openid'], // 还是这个用户的微信openid（按序）
						'group_id' => $querygroupinfo [$i] ['groupid'] // 注意微信返回的远程数据没有下划线
				);
			}else {
				$localformat [$i] = array(
						'openid' => $localuser [$i] ['openid'],
						'group_id' => $localuser [$i] ['group_id']
				);
				$remoteformat [$i] = array(
						'openid' => $localuser [$i] ['openid'], // 还是这个用户的微信openid（按序）
						'group_id' => $localuser [$i] ['group_id'] // 用户取消关注后没有组信息，不打算更新
				);
			}
		}
		//Step2：进行自动比对
		$checkresult = autoPick( $remoteformat, $localformat, 'openid' );
		//p($checkresult);die;
		
		$wutable = M ( 'wechatuserinfo' );
		for($i = 0; $i < count ( $checkresult ['update'] ); $i ++) {
			$updatemap = array(
					'openid' => $checkresult ['update'] [$i] ['openid'],
					'is_del' => 0
			);
			$syncOperated += $wutable->where($updatemap)->setField( 'group_id', $checkresult ['update'] [$i] ['group_id'] );
		}
		
		return $syncOperated;
	}
	
	public function testBatchMove() {
		$start = time();
		$swc = A ('Service/WeChat');
		
		$usermap = array(
				'enterprise_wechat' => $this->einfo ['original_id'],
				'is_del' => 0
		);
		$localuser = M ( 'wechatuserinfo' )->where( $usermap )->order( 'subscribe_time desc' )->limit(100)->select();
		
		$syncnum = count ( $localuser ); // 总计循环变量
		
		$openidlist = array(); // 用户分组
		for($i = 0; $i < $syncnum; $i ++) {
			$openidlist [$i] = $localuser [$i] ['openid'];
		}
		
		$togroupid = 116; // 移动到无限激情
		
		$result = $swc->batchMoveUserToGroup ( $this->einfo, $openidlist, $togroupid );
		
		$end = time();
		$timespan = $end - $start;
		p('请求并移动'.$syncnum.'个用户的分组完成，总计花了：'.$timespan.'秒!\n');p($result);die;
	}
	
}
?>