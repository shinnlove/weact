<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/bootstrap/css/bootstrap2.2.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/uniform/themes/default/css/uniform.default.css" media="screen" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/jquery-easyui-1.3.5/themes/default/easyui.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/jquery-easyui-1.3.5/themes/icon.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/uiColorButtonStyle.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/myUniformStyle.css" />
<script type="text/javascript" src="__PUBLIC__/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/uniform/jquery.uniform.js"></script>
<script type="text/javascript" src="__PUBLIC__/jquery-easyui-1.3.5/jquery.easyui.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/lhgcalendar/lhgcore.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/lhgcalendar/lhgcalendar.min.js"></script>
<title>添加优惠券</title>
</head>

<body>
    <form id="myCoupon" name="myCoupon" class="form-horizontal uniform" method="post" action="#" style="margin:0px; padding:10px;background:#fafafa;border:1px solid #DDD;min-width:800px;">
        <div class="control-group">
            <div class="controls controls-row"><h2>添加优惠券信息</h2></div>
            <div class="controls controls-row">
                <font style="font-size:1.17em; font-weight:bold; color:highlight;">步骤：第1步，共3步</font>
            </div>
        </div>
        
        <hr />
        
        <div class="control-group">
			<label class="control-label">
            	名称<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="coupon_name" name="coupon_name" placeholder="请填写优惠券的名称" required value="" />
            </div>
            <div class="controls controls-row">
            	如：生日券、抵扣券、年终红包等...
            </div>
        </div>
        
        <div class="control-group">
			<label class="control-label">
            	面额<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="denomination" name="denomination" placeholder="请填写优惠券的面额" required value="" />&nbsp;(元)
            </div>
        </div>
        
        <div class="control-group">
			<label class="control-label">
            	最低消费<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="lowest_consume" name="lowest_consume" placeholder="请填写优惠券启用的最低消费" required value="" />&nbsp;(元)
            </div>
            <div class="controls controls-row">
            	使用该券需消费的最低额度，没有限制请填写0
            </div>
        </div>
        
        <div class="control-group">
			<label class="control-label">
            	发放张数<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="publish_amount" name="publish_amount" placeholder="请填写优惠券的发放张数" required value="" />&nbsp;(张)
            </div>
            <div class="controls controls-row">
            	该券可被顾客领取的最大次数，如不限制数量或还不确定数量请填写0
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">
            	生效时间<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="start_time" name="start_time" placeholder="请选择优惠券生效时间" required value="" /> 
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">
				失效时间<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="end_time" name="end_time" placeholder="请选择优惠券失效时间" required value="" />
            </div>
        </div>
        
        <div class="control-group">
			<label class="control-label">
            	通用类别<span class="text-error">(*)</span>： 
            </label>
            <div class="controls controls-row" style="margin-top:3px;">
            	<select id="category_select" class="uniform myselected">
                    <option value="-1">请选择通用类别</option>
                    <option value="1">全国各店通用</option>
                    <option value="2">全国各店独立使用</option>
                    <option value="3">部分门店通用</option>
                    <option value="4">部分门店独立使用</option>
                </select>
			</div>
            <input type="hidden" id="current_category" name="current_category" value="-1" /><!--当前选择的分店-->
            <div class="controls controls-row">
            	如果选择部分门店（通用 / 独立使用），还需在下一步选择发行优惠券的门店。
            </div>
        </div>
        
        <div class="control-group">
			<label class="control-label">
            	价格限制<span class="text-error">(*)</span>： 
            </label>
            <div class="controls controls-row" style="margin-top:3px;">
            	<select id="price_select" class="uniform myselected">
                    <option value="-1">请选择价格限制</option>
                    <option value="0">所有商品适用</option>
                    <option value="1">仅限正价商品</option>
                </select>
			</div>
            <input type="hidden" id="price_limited" name="price_limited" value="-1" /><!--是否有价格限制-->
        </div>
        
        <div class="control-group">
			<label class="control-label"> 优惠券封面图片： </label>
			<div class="controls controls-row">
				<input type="text" class="uniform myinput" id="coupon_logo" name="coupon_logo" placeholder="可上传自定义优惠券封面图片，不上传则使用系统默认封面。" value="" />
                <br />
                <div class="btn">
                    <span style="font-size:12px;">添加附件:</span>
                    <input type="file" name="couponimage" class="couponimage uniform"/>
                </div>
                <div class="couponimagepreview" style="margin-top:10px;">
                	<img id="cp_img" name="cp_img" src="__PUBLIC__/images/coupon/activity-coupon-start.jpg" alt="" style="width:360px;" />
                </div>
			</div>
			<div class="controls controls-row" style="margin-top:10px;">
            	温馨提示：推荐最佳封面尺寸（比例）：600px × 300px，jpeg、png格式。
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">推广词：</label>
            <div class="controls controls-row">
                <textarea id="advertise_word" name="advertise_word" class="uniform mytextarea" placeholder="可填写该优惠券的推广信息"></textarea>
            </div>
            <div class="controls controls-row">
            	在用户领取优惠券的时候，会看到商家定制的推广语。<br />如：庆祝×××××开业5周年，年中大促××××优惠券大放送......
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">使用说明：</label>
            <div class="controls controls-row">
                <textarea id="instruction" name="instruction" class="uniform mytextarea" placeholder="可填写想告知顾客该优惠券使用须知的信息"></textarea>
            </div>
            <div class="controls controls-row">
            	如：本优惠券仅限×月内，购买正价商品时出示......
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">说明备注：</label>
            <div class="controls controls-row">
                <textarea id="coupon_description" name="coupon_description" class="uniform mytextarea" placeholder="可填写该优惠券的其他信息与备注"></textarea>
            </div>
            <div class="controls controls-row">
            	店家对优惠券的区别备注，可见度：自身。
            </div>
        </div>
        
        <div class="form-actions no-margin" style="margin-bottom:0px; background:#fafafa;">
            <a id="submitbtn" class="large ui-color-button light-green" href="javascript:void(0)">下一步</a>
            &nbsp;&nbsp;
            <a id="resetbtn" class="large ui-color-button blue" href="javascript:void(0)">重置</a>
            <a href="javascript:history.go(-1);">
                <img style="width:50px; float:right;" alt="返回" src="__PUBLIC__/images/goback.png" />
            </a>
        </div>
	</form>
    
<script type="text/javascript">
//获得当前时间
function currentTime(){
	var now = new Date();
	var year = now.getFullYear();       //年
	var month = now.getMonth() + 1;     //月
	var day = now.getDate();            //日
	var hh = now.getHours();            //时
	var mm = now.getMinutes();          //分
	var ss = now.getSeconds();			//秒
	var clock = year + "-";
	if (month < 10) clock += "0";
	clock += month + "-";
	if (day < 10) clock += "0";
	clock += day + " ";
	if (hh < 10) clock += "0";
	clock += hh + ":";
	if (mm < 10) clock += "0";
	clock += mm + ":";
	if (ss < 10) clock += "0";
	clock += ss;
	console.info(clock);
	return clock;
}

$(function (){
	$(".uniform").uniform();				//初始化uniform，文本框的uniform格式化
	
	/*有效日期的日历输出*/
	J(function(){
		J('#start_time').calendar({ format:'yyyy-MM-dd HH:mm:ss' });
		J('#end_time').calendar({ format:'yyyy-MM-dd HH:mm:ss' });
	});
	
	//初始化日期
	var ct = currentTime();
	$("#start_time").val(ct);
	$("#end_time").val(ct);
	
	//抓取优惠券所有DOM对象
	var cn = $("#coupon_name");			    //抓取优惠券名称文本框
	var dn = $("#denomination");		    //抓取优惠券面额文本框
	var lc = $("#lowest_consume");		    //抓取优惠券最低消费文本框
	var pa = $("#publish_amount");		    //抓取优惠券发放数量文本框
	var st = $("#start_time");				//抓取优惠券生效日期文本框
	var et = $("#end_time");			    //抓取优惠券失效日期文本框
	var cs = $("category_select");
	var cc = $("#current_category");	    //抓取优惠券当前通用类别文本框
	var ps = $("#price_select");
	var pl = $("#price_limited");			//抓取优惠券价格限制的文本框
	var cl = $("#coupon_logo");			    //抓取优惠券封面图片路径文本框
	var aw = $("#advertise_word");          //抓取优惠券推广词文本框
	var ins = $("#instruction");            //抓取优惠券使用说明文本框
	var cd = $("#coupon_description");	    //抓取优惠券备注描述文本框
	
	//优惠券通用类别选择框更改事件
	$("#category_select").change(function(){
		cc.val($(this).val());				//获取option选中的通用类别的value，并写入input里
	});
	
	//优惠券商品价格限制选择框变动事件
	$("#price_select").change(function(){
		pl.val($(this).val());				//获取option选中商品价格限制的value写入input框里
	});
	
	$(".couponimage").change(function(e) {
		var src = e.target || window.event.srcElement; //获取事件源，兼容chrome/IE
		if(e.target != null && e.target != ''){
			if(e.originalEvent && e.originalEvent.srcElement && e.originalEvent.srcElement.files && e.originalEvent.srcElement.files.length > 0){
				var file = e.originalEvent.srcElement.files[0];
				var reader = new FileReader();
				reader.onloadend = function(e) {
					$('#cp_img').attr('src', reader.result);			//读的是二进制
					$('#coupon_logo').val($(".couponimage").val());
		        };
		        reader.readAsDataURL(file);
			}
		}else{
			$('#cp_img').attr('src','');
			$('#coupon_logo').val($('.couponimage').val());
		}
	});
	
	//提交信息：下一步
	$("#submitbtn").click(function(){
		//Step1：判断优惠券名称是否填写
		if (cn.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券的名称!', 'warning', function(){
	  			cn.focus();						//注意聚焦和return的顺序！
	  		});
	  		return								//注意聚焦和return的顺序！
		}
		//Step2：判断优惠券面额是否合法输入
		if (dn.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券的面额!', 'warning', function(){
	  			dn.focus();
	  		});
	  		return
		}else{
			if(isNaN(dn.val()) || dn.val() <= 0){
				$.messager.alert('温馨提示', '请填写正确的优惠券面额!<br />只能是整数且大于0!', 'warning', function(){
					dn.focus();											//注意聚焦和return的顺序！
				});
				return;
			}
		}
		//Step3：判断优惠券最低消费金额是否合法输入
		if (lc.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券启用的最低消费金额!', 'warning', function(){
	  			lc.focus();
	  		});
	  		return
		}else{
			if(isNaN(lc.val()) || lc.val()<0){
				$.messager.alert('温馨提示', '请填写正确的可使用优惠券最低消费金额!<br />最低消费金额只能是整数且不小于0!','warning', function(){
					lc.focus();											//注意聚焦和return的顺序！
				});
				return;
			}
		}
		//Step4：判断优惠券发放数量是否合法输入
		if (pa.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券发放的数量!', 'warning', function(){
	  			pa.focus();
	  		});
	  		return
		}else{
			if(isNaN(pa.val()) || pa.val() <= 0){
				$.messager.alert('温馨提示', '请正确填写优惠券的发放数量!<br />发放数量只能是整数且大于0!','warning', function(){
					pa.focus();											//注意聚焦和return的顺序！
				});
				return;
			}
		}
		//Step5：判断是否填写开始日期
		if(st.val() == ''){
			$.messager.alert('温馨提示', '请选择优惠券生效日期!', 'warning', function(){
	  			st.focus();
	  		});
	  		return
		}
		//Step6：判断是否填写结束日期
		if(et.val() == ''){
			$.messager.alert('温馨提示', '请选择优惠券失效日期!', 'warning', function(){
	  			et.focus();
	  		});
	  		return
		}
		//Step7：判断优惠券的生效时间与失效时间段是否合法
		if( Date.parse( st.val() ) > Date.parse( et.val() ) ){
			$.messager.alert('温馨提示', '优惠券失效日期不得早于生效日期!', 'warning', function(){
				et.focus();											//注意聚焦和return的顺序！
			});
			return;
		}
		//Step8：判断优惠券的通用类别是否选择
		if(cc.val() == '-1'){
			$.messager.alert('温馨提示', '请选择优惠券的流通类型!', 'warning', function(){
				cc.focus();
	  		});
	  		return
		}
		//Step9：判断优惠券的价格限制是否选择
		if(pl.val() == '-1'){
			$.messager.alert('温馨提示', '请选择优惠券的价格限制!', 'warning', function(){
				pl.focus();
	  		});
	  		return
		}
		
		//验证通过，post提交
		$.messager.confirm('温馨提示', '确定提交所编辑的优惠券信息吗?', function(result){
			if(result) {
				$.post("{:U('Admin/Coupon/addCoupon','','')}", 
				{ 
					coupon_name : cn.val(),
					denomination : dn.val(),
					lowest_consume : lc.val(),
					publish_amount : pa.val(),
					start_time : st.val(),
					end_time : et.val(),
					circulation : cc.val(),
					original_price_only : pl.val(),
					coupon_cover : cl.val(),
					advertise : aw.val(),
					instruction : ins.val(),
					remark : cd.val()
				}, function(data){
						if(data.status == 1){
							window.location="{:U('addCouponSubbranch')}";
						}else{
							$.messager.alert('温馨提示', '添加失败!'+data.msg, 'warning');
						}
				},'json');
			}else {
				return
			}
		});
	});	
	
	//重置按钮
	$("#resetbtn").click(function(){
		$.messager.confirm('温馨提示', '确定重置吗?', function(result){
			if(result) {
				//重置所有
				cn.val('');
				dn.val('');
				lc.val('');
				pa.val('');
				st.val(currentTime);
				et.val(st.val());
				
				cc.val('-1');
				cs.val('-1');
				cs.change();
				
				pl.val('-1');
				ps.val('-1');
				ps.change();
				
				cl.val('');
				$(".uploader span[class='filename']").html('未选择文件');
				$('#cp_img').attr('src', '/APP/Tpl/Admin/Public/images/coupon/activity-coupon-start.jpg');
				
				aw.val('');
				ins.val('');
				cd.val('');
			}
		});
	});
});
</script>
</body>
</html>
