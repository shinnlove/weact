<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/bootstrap/css/bootstrap2.2.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/uniform/themes/default/css/uniform.default.css" media="screen" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/jquery-easyui-1.3.5/themes/default/easyui.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/colorBtnMyUniform.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/singleNewsStyle.css?v=1.0.1" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/appmsg.css?v=1.0.1" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/om-fileupload.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/ueditor2/themes/default/css/ueditor.css" />
<script type="text/javascript" src="__PUBLIC__/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/uniform/jquery.uniform.js"></script>
<script type="text/javascript" src="__PUBLIC__/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/jquery-easyui-1.3.5/jquery.easyui.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/operamasks-ui.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/operamasks/ui/om-core.js"></script>
<script type="text/javascript" src="__PUBLIC__/operamasks/ui/om-fileupload.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor2/ueditor.config.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor2/ueditor.all.js"></script>
<title>单图文添加</title>
</head>

<body>
	<div class="row">
		<div class="span5 msg-preview" style="width:320px;">
			<div class="msg-item-wrapper">
				<div id="appmsgItem1" class="msg-item">
					<h4 class="msg-t">
						<span class="i-title">标题</span>
					</h4>
					<p class="msg-meta">
						<span class="msg-date">{$date}</span>
					</p>
					<div class="cover">
						<p class="default-tip">封面图片</p>
						<img class="i-img" alt="" />
					</div>
					<p class="msg-text"></p>
				</div>
				<div class="msg-hover-mask"></div>
				<div class="msg-mask">
					<span class="dib msg-selected-tip"></span>
				</div>
			</div>
		</div>
		<div class="span7" style="width:450px;">
			<div class="msg-editer-wrapper">
				<div class="msg-editer">
					<form id="appmsg-form" class="form">
						<div class="control-group">
							<label class="control-label">标题</label>
								<span class="maroon">*</span>
								<span class="help-inline">(必填,不能超过36个字)</span>
							<div class="controls">
								<input type="text" id="title" name="title" class="span5 uniform newsinput" placeholder="请输入图文信息的标题" required="required" value="" />
							</div>
						</div>
						<div class="control-group">
							<label class="control-label">封面</label>
								<span class="maroon">*</span>
								<span class="help-inline">(必须上传一张图片)</span>
							<div class="controls">
								<div class="cover-area">
									<div class="cover-hd">
										<input id="file_upload" name="file_upload" type="file" />
										<input id="picsort" name="picsort" type="hidden" value="lanmu" />
										<input id="coverurl" name="coverurl" type="hidden" value="" />
									</div>
									<p id="upload-tip" class="upload-tip">封面图片最佳尺寸：900像素 × 500像素</p>
									<p id="imgArea" class="cover-bd" style="display: none;">
										<img src="" id="img" alt="" />
										<a href="javascript:;" class="vb cover-del" id="delImg">删除</a>
									</p>
								</div>
							</div>
						</div>
						<a id="desc-block-link" href="javascript:void(0);" class="url-link block">添加摘要</a>
						<div id="desc-block" style="display: none;" class="control-group">
							<label class="control-label">摘要</label>
							<span class="help-inline">(不能超过120个字)</span>
							<div class="controls">
								<textarea id="summary" name="summary" class="msg-txta uniform newsinput" placeholder="请在此输入图文摘要"></textarea>
							</div>
						</div>
						<div class="control-group" style="margin-bottom: 20px;">
							<label class="control-label">正文</label>
								<span class="maroon">*</span>
								<span class="help-inline">(必填,不能超过10000个字符)</span>
							<div class="controls">
								<script type="text/plain" id="editor"></script>
							</div>
						</div>
						<a id="chain-block-link" href="javascript:void(0);" class="url-link block">添加外链（适用引导活动）</a>
						<div id="chain-block" style="display: none;" class="control-group">
							<label class="control-label">外链地址</label>
							<span class="help-inline warning">(设置后点击图文不会进入详情，而跳转外链地址；留空取消外链)</span>
							<div class="controls">
								<input type="text" id="chain" name="chain" class="span5 uniform newsinput" placeholder="所添加的链接请以http://开头" required="required" value="" />
							</div>
						</div>
						<a id="url-block-link" href="javascript:void(0);" class="url-link block">添加原文链接（适用导读消息）</a>
						<div id="url-block" style="display: none;" class="control-group">
							<label class="control-label">原文链接</label>
							<span class="help-inline warning">(在图文详情页面中会生成阅读原文链接；留空取消原文链接)</span>
							<div class="controls">
								<input type="text" id="source_url" name="source_url" class="span5 uniform newsinput" placeholder="所添加的链接请以http://开头" required="required" value="" />
							</div>
						</div>

						<hr />

						<div class="control-group">
							<a id="save-btn" class="large ui-color-button light-green" href="javascript:void(0)">保存</a>
							&nbsp;&nbsp;
							<a id="cancel-btn" class="large ui-color-button blue" href="javascript:void(0)">取消</a>
						</div>
						<input id="action" name="action" type="hidden" value="add" />
					</form>
				</div>
				<span class="abs msg-arrow a-out" style="margin-top: 0px;"></span>
				<!-- 非常重要的图文侧边箭头标记 -->
				<span class="abs msg-arrow a-in" style="margin-top: 0px;"></span>
				<!-- 非常重要的图文侧边箭头标记 -->
			</div>
		</div>
	</div>

<script language="javascript">
$(function(){
	$(".uniform").uniform();						//初始化uniform，文本框的uniform格式化
	
	var msg_editor = UE.getEditor('editor',{
		imageUrl : "{:U('Admin/MaterialManageRequest/singleNewsImageHandle', '', '')}",
		imagePath : "__ROOT__",
		initialFrameWidth: 400,
		initialFrameHeight: 360
	});
	
	//监听ueditor图片插入，插入前设置图片宽度。
	msg_editor.addListener('beforeInsertImage', function (t, arg) {
		 for(i=0; i<arg.length; i++){
			 arg[i].width = 320;
		 }
	});
	
	//omfileupload图片上传之前的验证
	$("#file_upload").omFileUpload({
        action: "{:U('Admin/MaterialManageRequest/singleNewsCoverHandle', '', '')}", 
        swf : '__PUBLIC__/operamasks/ui/om-fileupload.swf',
        fileExt: "*.jpg;*.png;*.gif;*.jpeg;*.bmp",
        fileDesc: "Image Files",
        sizeLimit: 200 * 1024,
        autoUpload : true,
		method : 'GET',
		removeCompleted : true,
        onError: function(ID, fileObj, errorObj, event) {
            if (errorObj.type == "File Size") {
                $.messager.alert('温馨提示', '上传图片的大小不能超过200KB!', 'warning');
            }
        },
        actionData: {
            picsort: $("#picsort").val()
        },
        onComplete: function(ID, fileObj, response, data, event) {
            var jsonData = eval("(" + response + ")");
            if (jsonData.error == "filetype") {
                alert("文件上传格式只能支持：" + jsonData.allowtype);
                return false
            }
            $(".cover .i-img").attr("src", jsonData.fileUrl).show();
            $("#imgArea").show().find("#img").attr("src", jsonData.fileUrl);
            $("#coverurl").val(jsonData.fileName);
            $(".default-tip").hide()
        }
    });
	
	//各个按钮的验证
	$(".msg-editer #title").bind("keyup", function() {
        $(".i-title").text($(this).val())
    });
    $(".msg-editer #summary").bind("keyup", function() {
        //$(".msg-text").html($.htmlEncode($(this).val()))
        $(".msg-text").html($(this).val())
    });
    $("#desc-block-link").click(function(){
        $("#desc-block").show();
        $(this).hide()
    });
    $("#url-block-link").click(function(){
        $("#url-block").show();
        $(this).hide()
    });
    $("#chain-block-link").click(function(){
        $("#chain-block").show();
        $(this).hide()
    });
    $("#delImg").click(function(){
        $(".default-tip").show();
        $("#imgArea").hide();
        $("#coverurl").val("");
        $(".cover .i-img").hide()
    });
    
    $("#save-btn").click(function(){
    	$("#appmsg-form").submit();
    });
    
    $("#cancel-btn").click(function(){
    	$.messager.confirm('温馨提示', '确定放弃当前所有编辑、恢复为图文打开时的状态？', function(r){
			if(r) history.go(-1);
		});
    });
	
    // 图文提交的验证
    var validator = $("#appmsg-form").validate({
        rules: {
            title: {
                required: true,
                maxlength: 36
            },
            summary: {
                maxlength: 120
            },
            chain: {
                url: true
            },
            source_url: {
                url: true
            }
        },
        messages: {
            title: {
                required: "请输入标题",
                maxlength: "标题不能超过36个字"
            },
            summary: {
                maxlength: "标题不能超过120个字"
            },
            chain: {
                url: "必须输入正确的url格式"
            },
            source_url: {
                url: "必须输入正确的url格式"
            }
        },
        showErrors: function(errorMap, errorList) {
            if (errorList && errorList.length > 0) {
                $.each(errorList,
                function(index, obj) {
                    var item = $(obj.element);
                    item.closest(".control-group").addClass("error");
                    item.attr("title", obj.message)
                })
            } else {
                var item = $(this.currentElements);
                item.closest(".control-group").removeClass("error");
                item.removeAttr("title")
            }
        },
        submitHandler: function() {
        	// 参数验证
            if ($("#imgArea").css("display") == "none") {
                $.messager.alert('温馨提示', '请上传图文消息的封面图片!', 'warning');
                return false
            }
            var editorContent = msg_editor.getContent();
            var len = msg_editor.getContentLength(true);		//true代表计算忽略html的纯文本（中文一个字算一个）
            var chain = $("#chain").val();
            var sourceurl = $("#source_url").val();
            //alert(len); // 检测下字数统计得对不对，哈哈哈哈，OK，NND费了好大劲~
            
            var charLimit = 10000; // 预设字数10000
            var reg = /^(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:/~\+#]*[\w\-\@?^=%&amp;/~\+#])?/; // 匹配网址的正则表达式
            if (chain == "" && len == 0) {
            	$.messager.alert('温馨提示', '正文内容或者外链至少要填写一个!', 'warning');
                msg_editor.focus();
                return false;
            }
            if (len > charLimit) {
            	$.messager.alert('温馨提示', "正文的内容不能超过" + charLimit + "个字!", 'warning');
                msg_editor.focus();
                return false;
            }
            if (chain != "") {
            	var chainreg = chain.match(reg);
            	if(!chainreg){
					$.messager.alert('温馨提示', '外部链接网址不合法，请输入正确的网址，以http://或https://开头!', 'warning', function(){
						$("#chain").focus();
			  		});
					return false;
				}
            }
			if (sourceurl != "") {
            	var sourceurlreg = sourceurl.match(reg);
            	if(!sourceurlreg){
					$.messager.alert('温馨提示', '原文链接网址不合法，请输入正确的网址，以http://或https://开头!', 'warning', function(){
						$("#source_url").focus();
			  		});
					return false;
				}
            }
            
            var $form = $("#appmsg-form");
            var $btn = $("#save-btn");
            if ($btn.hasClass("disabled")) {
                return
            }
			var submitData = {
                title: $("input[name='title']", $form).val(),
                coverurl: $(".i-img").attr("src"),
                summary: $("textarea[name='summary']", $form).val(),
                main_content: editorContent,
                chain: $("#chain", $form).val(),
                source_url: $("input[name='source_url']", $form).val(),
            };
		    $btn.addClass("disabled");
		    $.post("{:U('Admin/MaterialManageRequest/addSingleNewsConfirm', '', '')}", submitData, function(result){
				$btn.removeClass("disabled");
				if(result.errCode == 0) {
					$.messager.alert('温馨提示', '保存成功。', 'info', function(){
	            		window.location.href = "{:U('Admin/MaterialManage/newsView', '', '')}";	//添加成功后直接跳转到图文中心预览
	            	});
				} else {
					$.messager.alert('温馨提示','保存失败，'+result.errMsg,'error');		//后台验证是否图文数目达到上限
				}
			}, 'json');
        }
    });
});
</script>
</body>
</html>