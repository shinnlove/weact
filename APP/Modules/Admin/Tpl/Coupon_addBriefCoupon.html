<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/bootstrap/css/bootstrap2.2.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/uniform/themes/default/css/uniform.default.css" media="screen" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/jquery-easyui-1.3.5/themes/default/easyui.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/ueditor/themes/default/css/ueditor.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/colorBtnMyUniform.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/weactbrand.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/uploadstyle.css" />
<script type="text/javascript" src="__PUBLIC__/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/webuploader.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/diywebuploader.js"></script>
<script type="text/javascript" src="__PUBLIC__/uniform/jquery.uniform.js"></script>
<script type="text/javascript" src="__PUBLIC__/jquery-easyui-1.3.5/jquery.easyui.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/lhgcalendar/lhgcore.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/lhgcalendar/lhgcalendar.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor/ueditor.all.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor/lang/zh-cn/zh-cn.js"></script>
<title>添加优惠券信息</title>
</head>

<body>
    <form name="myCoupon" class="form-horizontal uniform" method="post" action="#">
        
        <div class="control-group">
			<div class="controls controls-row"><h2>添加优惠券信息</h2></div>
	        <div class="controls controls-row">
	        	<font style="font-weight:bold; color:#666;">说明：</font><font style="color:highlight; line-height:22px;">本优惠券适用于线上商品，且只对已关注企业公众号或注册成为线上会员的顾客发放！</font><br />
	        	<font style="font-weight:bold; color:#666;">提示：</font><font style="color:highlight; line-height:22px;">此处可根据需求添加抵用券或折扣券两种优惠券！</font><br />
	        </div>
		</div>
        
        <hr />
        
        <input type="hidden" id="coupon_id" name="coupon_id" value="{$couponid}" /><!-- 隐藏框：优惠券的id编号 -->
        <!-- <input type="hidden" id="coupon_type" name="coupon_type" value="1" /> --><!-- 隐藏框：优惠券的类型编号 -->
        
        <div class="control-group">
			<label class="control-label">
            	优惠券名称<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mybriefinput" id="coupon_name" name="coupon_name" placeholder="请填写优惠券的名称" required value="" />
            </div>
            <div class="controls controls-row">
            	如：生日券、抵用券、年终红包等...
            </div>
        </div>
        
        <div class="control-group">
			<label class="control-label">
            	优惠券种类<span class="text-error">(*)</span>： 
            </label>
            <div class="controls controls-row" style="margin-top:3px;">
            	<select id="coupon_select" class="uniform myselected">
            	 	<option value="-1">请选择优惠券种类</option>
                    <option value="1">抵用券</option>
                    <option value="2">折扣券</option>
                </select>
			</div>
            <input type="hidden" id="coupon_type" name="coupon_type" value="-1" /><!--所选择优惠券的种类-->
            <div class="controls controls-row deduction" style="display:none;">
            	抵用券：消费时抵扣一定金额，可设起始额度
            </div>
            <div class="controls controls-row discount" style="display:none;">
            	折扣券：消费时直接打折
            </div>
        </div>
        
        <div class="control-group setDenomination" style="display:none;">
			<label class="control-label">
            	面额<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mybriefinput" id="denomination" name="denomination" placeholder="请填写优惠券的面额" required value="" />&nbsp;(元)
            </div>
            <div class="controls controls-row dedu_denomination">
            	给出直接减免的金额
            </div>
        </div>
        
        <div class="control-group setDiscount" style="display:none;">
			<label class="control-label">
            	折扣<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row"> 
                <input type="text" class="uniform mybriefinput" id="coupon_discount" name="coupon_discount" placeholder="请输入折扣百分数（%）" required value="" />
            </div>
            <div class="controls controls-row">
            	使用该券可以获得的折扣：输入0~100的整数，如80即打八折
            </div>
        </div> 
        
        <div class="control-group">
			<label class="control-label">
            	最低消费<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mybriefinput" id="lowest_consume" name="lowest_consume" placeholder="请输入要满足的最低消费金额" required value="0" />&nbsp;(元)
            </div>
            <div class="controls controls-row">
            	使用该券需消费的最低额度，0表示不限制最低消费。
            </div>
        </div>
        
        <div class="control-group">
			<label class="control-label">
            	发放张数<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mybriefinput" id="publish_amount" name="publish_amount" placeholder="请填写优惠券的发放张数" required value="" />&nbsp;(张)
            </div>
            <div class="controls controls-row">
            	该券可被顾客领取的最大次数，如不限制数量或还不确定数量请填写0
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">
            	生效时间<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="start_time" name="start_time" placeholder="请选择优惠券生效时间" required value="" /> 
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">
				失效时间<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="end_time" name="end_time" placeholder="请选择优惠券失效时间" required value="" />
            </div>
        </div>
 
        <div class="control-group">
        	<label class="control-label">优惠券封面<span class="text-error">(*)</span>： </label>
	        <div class="controls controls-row">
		        <input type="hidden" id="CSRFtoken" name="CSRFtoken" value="123456" /><!-- （可选参数）图片防注入提交 -->
				<input type="hidden" id="imgPath1" name="imgPath1" value="" /><!-- （必选参数）单次上传的图片path1 -->
			
				<!-- 一个webuploader begin -->
				<div class="webUploaderWrap ui-sortable" id="uploadWrap">
			        <div id="previewUpload" class="webuploader-container">
			            <div class="webuploader-pick">点击上传</div>
			        </div>
		    	</div>
	    	</div>
	    	<div class="controls controls-row" style="margin-top:10px;">
            	温馨提示：推荐最佳封面尺寸（比例）：600px × 300px，jpeg、png格式。
            </div>
    	</div>
    	<!-- 一个webuploader end -->
        
        <div class="control-group">
            <label class="control-label">推广词：</label>
            <div class="controls controls-row">
                <textarea id="advertise_word" name="advertise_word" class="uniform mytextarea" placeholder="可填写该优惠券的推广信息"></textarea>
            </div>
            <div class="controls controls-row">
            	在用户领取优惠券的时候，会看到商家定制的推广语。<br />如：庆祝×××××开业5周年，年中大促××××优惠券大放送......
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">说明备注：</label>
            <div class="controls controls-row">
                <textarea id="coupon_description" name="coupon_description" class="uniform mytextarea" placeholder="可填写该优惠券的其他信息与备注"></textarea>
            </div>
            <div class="controls controls-row">
            	店家对优惠券的区别备注，可见度：自身。
            </div>
        </div>
        
         <div class="control-group">
            <label class="control-label">
                使用规则<span class="text-error">(*)</span>：
            </label> 
            <div class="controls controls-row">
                <div class="ueditorContainer" id="instruction">
                    <script id="container" type="text/plain" style="width:605px;height:300px;margin:0px;"></script>
                </div>
            </div>
        </div>
        
        <hr />
        
        <div class="handle-action">
            <a id="submitbtn" class="large ui-color-button light-green" href="javascript:void(0)">提交</a>
            &nbsp;&nbsp;
            <a id="cancelbtn" class="large ui-color-button blue" href="javascript:history.go(-1);">取消</a>
            <a href="javascript:history.go(-1);">
                <img style="width:50px; float:right;" alt="返回" src="__PUBLIC__/images/goback.png" />
            </a>
        </div> 
	</form>
    
<script type="text/javascript">
//定义webuploader的js位置、flash位置和上传处理图片的服务器地址（必须的参数，否则无法处理图片）
var serverhandleimg = '{:U("Admin/CouponRequest/singleUploadHandle", "", "")}'; // 上传的服务器处理图片地址

//获得当前时间
function currentTime(){
	var now = new Date();
	var year = now.getFullYear();       //年
	var month = now.getMonth() + 1;     //月
	var day = now.getDate();            //日
	var hh = now.getHours();            //时
	var mm = now.getMinutes();          //分
	var ss = now.getSeconds();			//秒
	var clock = year + "-";
	if (month < 10) clock += "0";
	clock += month + "-";
	if (day < 10) clock += "0";
	clock += day + " ";
	if (hh < 10) clock += "0";
	clock += hh + ":";
	if (mm < 10) clock += "0";
	clock += mm + ":";
	if (ss < 10) clock += "0";
	clock += ss;
	console.info(clock);
	return clock;
}

$(function (){
	$(".uniform").uniform();				//初始化uniform，文本框的uniform格式化
	
	/*有效日期的日历输出*/
	J(function(){
		J('#start_time').calendar({ format:'yyyy-MM-dd HH:mm:ss' });
		J('#end_time').calendar({ format:'yyyy-MM-dd HH:mm:ss' });
	});
	
	var cid = $("#coupon_id").val();
	var ue = UE.getEditor('container',{
		imageUrl : "{:U('Admin/CouponRequest/instructionImageHandle')}?cid="+cid,
		imagePath : "__ROOT__"
	});
	
	//监听ueditor图片插入，插入前设置图片宽度（不让图片太大）。
	ue.addListener('beforeInsertImage', function (t, arg) {
		 for(i=0; i<arg.length; i++){
			 arg[i].width = 300;									//防止手机上显示超出屏幕
		 }
	});
	
	//优惠券性质种类改变函数
	$("#coupon_select").change(function(){
		var selected_type = $(this).val();								//获得选中的选项的value
		if(selected_type == 1){
			$('.deduction').css('display','block');	
			$('.discount').css('display','none');
			$('.setDiscount').css('display','none');
			$('.setDenomination').css('display','block');
			$("#coupon_discount").val('');
		}else if(selected_type == 2){
			$('.deduction').css('display','none');
			$('.discount').css('display','block');
			$('.setDiscount').css('display','block');
			$('.setDenomination').css('display','none');
			$("#denomination").val('');
		}else{
			$('.deduction').css('display','none');	
			$('.discount').css('display','none');
			$('.setDiscount').css('display','none');
			$('.setDenomination').css('display','none');
			$("#denomination").val('');
			$("#coupon_discount").val('');
		}
		$('#coupon_type').val(selected_type);							//获取option的value，并写入input里，用作提交的时候判断	
	});
	
	//初始化日期
	var ct = currentTime();
	$("#start_time").val(ct);
	$("#end_time").val(ct);
	
	//优惠券封面图片上传处理
	$("#previewUpload").singleImgUploader({
		// 必填图片参数
		width : 300, // 图片宽度限制300px
		height : 200, // 图片高度限制200px
		// 可选性能参数
		limitSizeLarger : true, // 是否限制图片大小（可以为true|false）
		// 可选回调参数（可以不写）
		imgPathInput : $("#imgPath1"), // 图片路径会写入哪个input输入框，自己定义id|class的名字，此处举例imgpath1
	});
	
	//提交信息：下一步
	$("#submitbtn").click(function(){
		//抓取优惠券所有DOM对象
		var cid = $("#coupon_id");
		var cn = $("#coupon_name");							//抓取优惠券名称文本框
		var ct = $("#coupon_type");
		var dn = $("#denomination");						//抓取优惠券面额文本框
		var cdis = $("#coupon_discount");					//抓取优惠券折扣数文本框
		var lc = $("#lowest_consume");						//抓取优惠券最低消费文本框
		var pa = $("#publish_amount");						//抓取优惠券发放数量文本框
		var st = $("#start_time");							//抓取优惠券生效日期文本框
		var et = $("#end_time");							//抓取优惠券失效日期文本框
		var ip = $("#imgPath1");							//抓取优惠券封面图片路径文本框
		var aw = $("#advertise_word");						//抓取优惠券推广词文本框
		var cd = $("#coupon_description");					//抓取优惠券备注描述文本框
		var ins = UE.getEditor('container').getContent();	//抓取优惠券规则描述的UEditor框
		
		//Step1：判断优惠券名称是否填写
		if (cn.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券的名称!', 'warning', function(){
	  			cn.focus();						         //注意聚焦和return的顺序！
	  		});
	  		return								
		}
		
		//Step2：判断优惠券种类是否选择
		if (ct.val() == '-1'){
			$.messager.alert('温馨提示', '请选择优惠券种类!', 'warning', function(){
	  			ct.focus();						         //注意聚焦和return的顺序！
	  		});
	  		return								
		}
		
		//Step3:判断优惠券面额或折扣是否合法输入
		if(ct.val() == '1'){
			if (dn.val() == ''){
				$.messager.alert('温馨提示', '请填写优惠券的面额!', 'warning', function(){
		  			dn.focus();
		  		});
		  		return
			}else{
				if(isNaN(dn.val()) || dn.val() <= 0){
					$.messager.alert('温馨提示', '请正确填写优惠券面额：大于0的数字格式!', 'warning', function(){
						dn.focus();											//注意聚焦和return的顺序！
					});
					return;
				}
			}
		}else if(ct.val() == '2'){
			if ( cdis.val() == ''){
				$.messager.alert('温馨提示', '请填写优惠券的折扣数!', 'warning', function(){
		  			cdis.focus();
		  		});
		  		return
			}else{
				if(!isPositiveNum(cdis.val()) || cdis.val() <= 0 || cdis.val() >= 100){
					$.messager.alert('温馨提示', '请正确输入优惠券折扣数0~100（整数格式）!', 'warning', function(){
						cdis.focus();											//注意聚焦和return的顺序！
					});
					return;
				}
			}
		}
		
		//Step4：判断优惠券最低消费金额是否合法输入
		if (lc.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券启用的最低消费金额!', 'warning', function(){
	  			lc.focus();
	  		});
	  		return
		}else{
			if(isNaN(lc.val()) || lc.val()< 0){
				$.messager.alert('温馨提示', '请正确填写可使用优惠券的最低消费金额（数字格式）!','warning', function(){
					lc.focus();											//注意聚焦和return的顺序！
				});
				return;
			}
		}
		
		//Step5：判断优惠券发放数量是否合法输入
		if (pa.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券发放的数量!', 'warning', function(){
	  			pa.focus();
	  		});
	  		return
		}else{
			if(!isPositiveNum(pa.val())){
				$.messager.alert('温馨提示', '请正确填写优惠券的发放数量（整数格式）!','warning', function(){
					pa.focus();											//注意聚焦和return的顺序！
				});
				return;
			}
		}
		
		//Step6：判断是否填写开始日期
		if(st.val() == ''){
			$.messager.alert('温馨提示', '请选择优惠券生效日期!', 'warning', function(){
	  			st.focus();
	  		});
	  		return
		}
		
		//Step7：判断是否填写结束日期
		if(et.val() == ''){
			$.messager.alert('温馨提示', '请选择优惠券失效日期!', 'warning', function(){
	  			et.focus();
	  		});
	  		return
		}
		
		//Step8：判断优惠券的生效时间与失效时间段是否合法
		if( Date.parse( st.val() ) > Date.parse( et.val() ) ){
			$.messager.alert('温馨提示', '优惠券失效日期不得早于生效日期!', 'warning', function(){
				et.focus();											   //注意聚焦和return的顺序！
			});
			return;
		}
		
		//判断是否上传封面图片
		if(ip.val() == ''){
			$.messager.alert('温馨提示', '请上传优惠券封面图片!', 'warning', function(){
	  			ip.focus();
	  		});
	  		return
		}
		
		//Step9：判断优惠券使用规则描述是否填写
		if(ins == "" || ins == null){
			$.messager.alert('温馨提示', '请填写优惠券使用规则!', 'warning');
	  		return
		}
		
		//验证通过，post提交
		$.messager.confirm('温馨提示', '确定提交所编辑的优惠券信息吗?', function(result){
			if(result) {
				$.post("{:U('Admin/CouponRequest/addBriefCouponCfm','','')}", 
				{ 
					cid : cid.val(),
					cn : cn.val(),
					ct : ct.val(),
					dn : dn.val(),
					cdis : cdis.val(),
					lc : lc.val(),
					pa : pa.val(),
					st : st.val(),
					et : et.val(),
					ip : ip.val(),
					aw : aw.val(),
					cd : cd.val(),
					ins : ins
				}, function(result){
						if(result.errCode == 0){
							window.location="{:U('Admin/Coupon/shopCoupon')}";
						}else{
							$.messager.alert('温馨提示', '添加失败!'+result.errMsg, 'warning');
						}
				},'json');
			}
		});
	});	
});

//判断str是否大于0或等于0的整数
function isPositiveNum(str){
	var reg=/^\d+$/;
	return reg.test(str);
}
</script>
</body>
</html>