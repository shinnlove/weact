<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/bootstrap/css/bootstrap2.2.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/uniform/themes/default/css/uniform.default.css" media="screen" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/jquery-easyui-1.3.5/themes/default/easyui.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/jquery-easyui-1.3.5/themes/icon.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/ueditor/themes/default/css/ueditor.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/uiColorButtonStyle.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/myUniformStyle.css" />
<script type="text/javascript" src="__PUBLIC__/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/uniform/jquery.uniform.js"></script>
<script type="text/javascript" src="__PUBLIC__/jquery-easyui-1.3.5/jquery.easyui.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor/ueditor.all.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor/lang/zh-cn/zh-cn.js"></script>
<script type="text/javascript" src="__PUBLIC__/lhgcalendar/lhgcore.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/lhgcalendar/lhgcalendar.min.js"></script>
<title>添加优惠券信息</title>
</head>

<body>
    <form id="myCoupon" name="myCoupon" class="form-horizontal uniform" method="post" action="#" style="margin:0px; padding:10px;background:#fafafa;border:1px solid #DDD;min-width:800px;">
        <div class="control-group">
            <div class="controls controls-row"><h2>添加特价券信息</h2></div>
            <div class="controls controls-row">
                <font style="font-size:1.17em; font-weight:bold; color:highlight;">步骤：第2步，共3步</font>
            </div>
             <div class="controls controls-row">
                <font style="font-size:1.17em; font-weight:bold; color:highlight;">说明：对某款商品进行特价（需指定商品款号）</font>
            </div>
        </div>
        
        <hr />
        
        <input type="hidden" id="coupon_id" name="coupon_id" value="woaiqianqian" /><!-- 隐藏框：优惠券的id编号 -->
        <input type="hidden" id="coupon_type" name="coupon_type" value="3" /><!-- 隐藏框：优惠券的类型编号 -->
        <div class="control-group">
			<label class="control-label">
            	名称<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="coupon_name" name="coupon_name" placeholder="请填写优惠券的名称" required value="" />
            </div>
            <div class="controls controls-row">
            	如：周年庆××商品特价券等...
            </div>
        </div>
        
        <div class="control-group">
			<label class="control-label">
            	特价价格<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="promotion" name="promotion" placeholder="请填写优惠券的面额" required value="" />&nbsp;(元)
            </div>
            <div class="controls controls-row">
            	<font style="color:#F20;">1、商品现有的价格为原价，请给出使用此特价券后商品的特价价格。<br />2、特价券针对某款商品，下一步将进入选商品页面。</font>
            </div>
           
        </div>

        <div class="control-group">
			<label class="control-label">
            	发放张数<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="publish_amount" name="publish_amount" placeholder="请填写优惠券的发放张数" required value="" />&nbsp;(张)
            </div>
            <div class="controls controls-row">
            	该券可被顾客领取的最大次数，如不限制数量或还不确定数量请填写0
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">
            	生效时间<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="start_time" name="start_time" placeholder="请选择优惠券生效时间" required value="" /> 
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">
				失效时间<span class="text-error">(*)</span>：
            </label>
            <div class="controls controls-row">
                <input type="text" class="uniform mytimeinput" id="end_time" name="end_time" placeholder="请选择优惠券失效时间" required value="" />
            </div>
        </div>
 
        <div class="control-group">
			<label class="control-label"> 优惠券封面图片： </label>
			<div class="controls controls-row">
				<input type="text" class="uniform myinput" id="coupon_logo" name="coupon_logo" placeholder="可上传自定义优惠券封面图片，不上传则使用系统默认封面。" value="" />
                <br />
                <div class="btn">
                    <span style="font-size:12px;">添加附件:</span>
                    <input type="file" name="couponimage" class="couponimage uniform"/>
                </div>
                <div class="couponimagepreview" style="margin-top:10px;">
                	<img id="cp_img" name="cp_img" src="__PUBLIC__/images/coupon/activity-coupon-start.jpg" alt="" style="width:360px;" />
                </div>
			</div>
			<div class="controls controls-row" style="margin-top:10px;">
            	温馨提示：推荐最佳封面尺寸（比例）：600px × 300px，jpeg、png格式。
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">推广词：</label>
            <div class="controls controls-row">
                <textarea id="advertise_word" name="advertise_word" class="uniform mytextarea" placeholder="可填写该优惠券的推广信息"></textarea>
            </div>
            <div class="controls controls-row">
            	在用户领取优惠券的时候，会看到商家定制的推广语。<br />如：庆祝×××××开业5周年，年中大促××××优惠券大放送......
            </div>
        </div>
        
        <div class="control-group">
            <label class="control-label">说明备注：</label>
            <div class="controls controls-row">
                <textarea id="coupon_description" name="coupon_description" class="uniform mytextarea" placeholder="可填写该优惠券的其他信息与备注"></textarea>
            </div>
            <div class="controls controls-row">
            	店家对优惠券的区别备注，可见度：自身。
            </div>
        </div>
        
         <div class="control-group">
            <label class="control-label">
                使用规则说明<span class="text-error">(*)</span>：
            </label> 
            <div class="controls controls-row">
                <div class="ueditorContainer" id="instruction">
                    <script id="container" type="text/plain" style="width:605px;height:300px;margin:0px;"></script>
                </div>
            </div>
        </div>
        
        <div class="form-actions no-margin" style="margin-bottom:0px; background:#fafafa;">
            <a id="submitbtn" class="large ui-color-button light-green" href="javascript:void(0)">下一步</a>
            &nbsp;&nbsp;
            <a id="resetbtn" class="large ui-color-button blue" href="javascript:void(0)">重置</a>
            <a href="javascript:history.go(-1);">
                <img style="width:50px; float:right;" alt="返回" src="__PUBLIC__/images/goback.png" />
            </a>
        </div> 
	</form>
    
<script type="text/javascript">
//获得当前时间
function currentTime(){
	var now = new Date();
	var year = now.getFullYear();       //年
	var month = now.getMonth() + 1;     //月
	var day = now.getDate();            //日
	var hh = now.getHours();            //时
	var mm = now.getMinutes();          //分
	var ss = now.getSeconds();			//秒
	var clock = year + "-";
	if (month < 10) clock += "0";
	clock += month + "-";
	if (day < 10) clock += "0";
	clock += day + " ";
	if (hh < 10) clock += "0";
	clock += hh + ":";
	if (mm < 10) clock += "0";
	clock += mm + ":";
	if (ss < 10) clock += "0";
	clock += ss;
	console.info(clock);
	return clock;
}

$(function (){
	$(".uniform").uniform();				//初始化uniform，文本框的uniform格式化
	
	/*有效日期的日历输出*/
	J(function(){
		J('#start_time').calendar({ format:'yyyy-MM-dd HH:mm:ss' });
		J('#end_time').calendar({ format:'yyyy-MM-dd HH:mm:ss' });
	});
	
	var cid = $("#coupon_id").val();
	var ue = UE.getEditor('container',{
		imageUrl : "{:U('Admin/CouponRequest/instructionImageHandle')}?cid="+cid,
		imagePath : "__ROOT__"
	});
	
	//监听ueditor图片插入，插入前设置图片宽度（不让图片太大）。
	ue.addListener('beforeInsertImage', function (t, arg) {
		 for(i=0; i<arg.length; i++){
			 arg[i].width = 580;									//防止手机上显示超出屏幕
		 }
	});
	
	//初始化日期
	var ct = currentTime();
	$("#start_time").val(ct);
	$("#end_time").val(ct);
	
	//优惠券封面图片上传处理
	$(".couponimage").change(function(e) {
		var src = e.target || window.event.srcElement; //获取事件源，兼容chrome/IE
		if(e.target != null && e.target != ''){
			if(e.originalEvent && e.originalEvent.srcElement && e.originalEvent.srcElement.files && e.originalEvent.srcElement.files.length > 0){
				var file = e.originalEvent.srcElement.files[0];
				var reader = new FileReader();
				reader.onloadend = function(e) {
					$('#cp_img').attr('src', reader.result);			//读的是二进制
					$('#coupon_logo').val($(".couponimage").val());
		        };
		        reader.readAsDataURL(file);
			}
		}else{
			$('#cp_img').attr('src','');
			$('#coupon_logo').val($('.couponimage').val());
		}
	});
	
	//提交信息：下一步
	$("#submitbtn").click(function(){
		
		//抓取优惠券所有DOM对象
		var cn = $("#coupon_name");							//抓取优惠券名称文本框
		var pro = $("#promotion");							//抓取优惠券折扣数文本框
		var pa = $("#publish_amount");						//抓取优惠券发放数量文本框
		var st = $("#start_time");							//抓取优惠券生效日期文本框
		var et = $("#end_time");							//抓取优惠券失效日期文本框
		var aw = $("#advertise_word");						//抓取优惠券推广词文本框
		var cd = $("#coupon_description");					//抓取优惠券备注描述文本框
		var ins = UE.getEditor('container').getContent();	//抓取优惠券规则描述的UEditor框
		
		//Step1：判断优惠券名称是否填写
		if (cn.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券的名称!', 'warning', function(){
	  			cn.focus();						         //注意聚焦和return的顺序！
	  		});
	  		return								
		}
		
		//Step2：判断优惠券的现价是否合法输入
		if (pro.val() == ''){
			$.messager.alert('温馨提示', '请填写使用优惠券后商品的现价!', 'warning', function(){
	  			pro.focus();
	  		});
	  		return
		}else{
			if(isNaN(pro.val()) || pro.val() <= 0){
				$.messager.alert('温馨提示', '请填写正确的优惠券的特价!<br />只能是整数且大于0!', 'warning', function(){
					pro.focus();											//注意聚焦和return的顺序！
				});
				return;
			}
		}
		
		//Step3：判断优惠券发放数量是否合法输入
		if (pa.val() == ''){
			$.messager.alert('温馨提示', '请填写优惠券发放的数量!', 'warning', function(){
	  			pa.focus();
	  		});
	  		return
		}else{
			if(isNaN(pa.val()) || pa.val() <= 0){
				$.messager.alert('温馨提示', '请正确填写优惠券的发放数量!<br />发放数量只能是整数且大于0!','warning', function(){
					pa.focus();											//注意聚焦和return的顺序！
				});
				return;
			}
		}
		
		//Step4：判断是否填写开始日期
		if(st.val() == ''){
			$.messager.alert('温馨提示', '请选择优惠券生效日期!', 'warning', function(){
	  			st.focus();
	  		});
	  		return
		}
		
		//Step5：判断是否填写结束日期
		if(et.val() == ''){
			$.messager.alert('温馨提示', '请选择优惠券失效日期!', 'warning', function(){
	  			et.focus();
	  		});
	  		return
		}
		
		//Step6：判断优惠券的生效时间与失效时间段是否合法
		if( Date.parse( st.val() ) > Date.parse( et.val() ) ){
			$.messager.alert('温馨提示', '优惠券失效日期不得早于生效日期!', 'warning', function(){
				et.focus();											   //注意聚焦和return的顺序！
			});
			return;
		}
		
		//Step7：判断优惠券使用规则描述是否填写
		if(ins == "" || ins == null){
			$.messager.alert('温馨提示', '请填写使用规则描述信息!', 'warning');
	  		return
		}
		
		//验证通过，post提交
		$.messager.confirm('温馨提示', '确定提交所编辑的优惠券信息吗?', function(result){
			if(result) {
				$.post("{:U('Admin/CouponRequest/addCouponSecondConfirm','','')}", 
				{ 
					coupon_name : cn.val(),
					promotion : pro.val(),
					lowest_consume : lc.val(),
					publish_amount : pa.val(),
					start_time : st.val(),
					end_time : et.val(),
					advertise : aw.val(),
					instruction : ins,
					remark : cd.val()
				}, function(data){
						if(data.status == 1){
							window.location="{:U('Admin/Coupon/addCouponSubbranch')}";
						}else{
							$.messager.alert('温馨提示', '添加失败!'+data.msg, 'error');
						}
				},'json');
			}
		});
	});	
	
	//重置按钮
	$("#resetbtn").click(function(){
		$.messager.confirm('温馨提示', '确定重置吗?', function(result){
			if(result) {
				//重置所有
				$("#coupon_name").val('');
				$("#promotion").val('');
				$("#publish_amount").val('');
				$("#start_time").val(currentTime());
				$("#end_time").val($("#start_time").val());
								
				$("#coupon_logo").val('http://www.we-act.cn__PUBLIC__/images/coupon/activity-coupon-start.jpg');
				$(".uploader span[class='filename']").html('未选择文件');
				$('#cp_img').attr('src', '__PUBLIC__/images/coupon/activity-coupon-start.jpg');
				
				$("#advertise_word").val('');
				$("#coupon_description").val('');
				UE.getEditor('container').setContent('');
			}
		});
	});
});
</script>
</body>
</html>