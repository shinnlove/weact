define(function(){return function(x){(function(e){var f={init:function(a){return this.each(function(){var b=e(this),c=b.data("eraser");if(!c){var d=function(){var d=b.width(),m=b.height(),q=b.offset(),g=e("<canvas/>"),l=g.get(0),n=a&&a.size?a.size:40,u=a&&a.completeRatio?a.completeRatio:.7,v=a&&a.completeFunction?a.completeFunction:null,r=[],s=Math.floor(d/n),t=s*Math.floor(m/n),w=t,k=l.getContext("2d"),p=b[0];b.after(g);l.id=p.id;l.className=p.className;l.width=d;l.height=m;k.drawImage(p,0,0,d,m);
b.remove();k.globalCompositeOperation="destination-out";k.strokeStyle="rgba(255,0,0,255)";k.lineWidth=n;k.lineCap="round";g.bind("mousedown.eraser",f.mouseDown);g.bind("touchstart.eraser",f.touchStart);g.bind("touchmove.eraser",f.touchMove);for(g.bind("touchend.eraser",f.touchEnd);w--;)r.push(1);c={posX:q.left,posY:q.top,touchDown:!1,touchID:-999,touchX:0,touchY:0,ptouchX:0,ptouchY:0,canvas:g,ctx:k,w:d,h:m,source:p,size:n,parts:r,colParts:s,numParts:t,ratio:0,complete:!1,completeRatio:u,completeFunction:v};
g.data("eraser",c);e(window).resize(function(){var a=g.offset();c.posX=a.left;c.posY=a.top})};this.complete&&0<this.naturalWidth?d():b.load(d)}})},touchStart:function(a){var b=e(this).data("eraser");if(!b.touchDown){var c=a.originalEvent.changedTouches[0],d=c.pageX-b.posX,h=c.pageY-b.posY;f.evaluatePoint(b,d,h);b.touchDown=!0;b.touchID=c.identifier;b.touchX=d;b.touchY=h;a.preventDefault()}},touchMove:function(a){var b=e(this).data("eraser");if(b.touchDown)for(var c=a.originalEvent.changedTouches,
d=c.length;d--;)if(c[d].identifier==b.touchID){var h=c[d].pageX-b.posX,c=c[d].pageY-b.posY;f.evaluatePoint(b,h,c);b.ctx.beginPath();b.ctx.moveTo(b.touchX,b.touchY);b.touchX=h;b.touchY=c;b.ctx.lineTo(b.touchX,b.touchY);b.ctx.stroke();a.preventDefault();break}},touchEnd:function(a){var b=e(this).data("eraser");if(b.touchDown)for(var c=a.originalEvent.changedTouches,d=c.length;d--;)if(c[d].identifier==b.touchID){b.touchDown=!1;a.preventDefault();break}},evaluatePoint:function(a,b,c){b=Math.floor(b/a.size)+
Math.floor(c/a.size)*a.colParts;0<=b&&b<a.numParts&&(a.ratio+=a.parts[b],a.parts[b]=0,!a.complete&&a.ratio/a.numParts>=a.completeRatio&&(a.complete=!0,null!=a.completeFunction&&a.completeFunction()))},mouseDown:function(a){var b=e(this),c=b.data("eraser"),d=a.pageX-c.posX,h=a.pageY-c.posY;f.evaluatePoint(c,d,h);c.touchDown=!0;c.touchX=d;c.touchY=h;c.ctx.beginPath();c.ctx.moveTo(c.touchX-1,c.touchY);c.ctx.lineTo(c.touchX,c.touchY);c.ctx.stroke();b.bind("mousemove.eraser",f.mouseMove);e(document).bind("mouseup.eraser",
c,f.mouseUp);a.preventDefault()},mouseMove:function(a){var b=e(this).data("eraser"),c=a.pageX-b.posX,d=a.pageY-b.posY;f.evaluatePoint(b,c,d);b.ctx.beginPath();b.ctx.moveTo(b.touchX,b.touchY);b.touchX=c;b.touchY=d;b.ctx.lineTo(b.touchX,b.touchY);b.ctx.stroke();a.preventDefault()},mouseUp:function(a){var b=a.data,c=b.canvas;b.touchDown=!1;c.unbind("mousemove.eraser");e(document).unbind("mouseup.eraser");a.preventDefault()},clear:function(){var a=e(this).data("eraser");if(a){a.ctx.clearRect(0,0,a.w,
a.h);for(var b=a.numParts;b--;)a.parts[b]=0;a.ratio=a.numParts;a.complete=!0;null!=a.completeFunction&&a.completeFunction()}},size:function(a){var b=e(this).data("eraser");b&&a&&(b.size=a,b.ctx.lineWidth=a)},reset:function(){var a=e(this).data("eraser");if(a){a.ctx.globalCompositeOperation="source-over";a.ctx.drawImage(a.source,0,0);a.ctx.globalCompositeOperation="destination-out";for(var b=a.numParts;b--;)a.parts[b]=1;a.ratio=0;a.complete=!1}}};e.fn.eraser=function(a){if(f[a])return f[a].apply(this,
Array.prototype.slice.call(arguments,1));if("object"!==typeof a&&a)e.error("Method "+a+" does not yet exist on jQuery.eraser");else return f.init.apply(this,arguments)}})(jQuery)}});